{% extends "place/tabbed_layout.html" %}
{% load indigo_app humanize staticfiles %}

{% block title %}{{ place.name }}{% endblock %}
{% block view-id %}library-view{% endblock %}

{% block content %}
<div class="container mt-3 mb-5">

  <div class="d-flex justify-content-between mb-3">
    <div class="mr-auto">
      {% if latest_completeness_stat %}
        <h6 class="text-center">Core Details</h6>
        <div class="d-flex">
          <div class="p-relative mr-2" style="height: 50px; width: 150px;">
            <canvas id="completeness-chart" data-values="{{ completeness_history|join:',' }}"></canvas>
          </div>
          <div>
            {% include 'indigo_metrics/_progress_ball.html' with size=50 progress=latest_completeness_stat.p_breadth_complete %}
          </div>
          <div class="ml-2">
            <h3 class="mb-0">{{ latest_completeness_stat.p_breadth_complete }}%</h3>
            Complete
          </div>
          <div class="ml-3 text-center align-self-center">
            <h3 class="mb-0">{{ latest_completeness_stat.n_complete_works }} of {{ latest_completeness_stat.n_works }}</h3>
            Works Complete
          </div>
        </div>
      {% endif %}
    </div>

    <div>
      <div class="btn-group">
        <a href="{% url 'new_work' place=place.place_code %}" class="btn btn-success">New work</a>
        {% if perms.indigo_api.bulk_add_work %}
          <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="sr-only">Toggle Dropdown</span></button>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="{% url 'new_batch_work' place=place.place_code %}">New work batch</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      {% include 'indigo_api/_work_filter_form.html' with form=form %}
    </div>

    <div id="library">
      <div class="list-group list-group-flush">
        <div class="list-group-item ml-4">{{ paginator.count }} works</div>

        {% for work in works %}
          <div class="list-group-item list-group-item-action p-2" data-toggle="collapse" data-target="#work-detail-{{ work.pk }}">
            <div class="d-flex">
              <div class="float-left">
                <span class="text-muted fas fa-caret-right fa-fw collapse-indicator"></span>
              </div>

              <div class="float-left flex-fill">
                <div class="d-flex">
                  <div class="col-6">
                    <div>
                      <a href="{% url 'work' frbr_uri=work.frbr_uri %}">{{ work.title }}</a>
                      {% if work.stub %}
                        <span class="badge badge-info">stub</span>
                      {% endif %}
                      {% if work.repealed_date %} 
                        <span class="badge badge-info">repealed</span>
                      {% endif %}
                    </div>
                    <div class="text-muted">{{ work.frbr_uri }}</div>
                    {% if work.parent_work %}
                      <div>
                        Primary work: <a href="{% url 'work' frbr_uri=work.parent_work.frbr_uri %}" data-popup-url="{% url 'work_popup' frbr_uri=work.parent_work.frbr_uri %}">{{ work.parent_work.title }}</a>
                      </div>
                    {% endif %}
                  </div>

                  <div class="col-2">
                    {% if work.task_stats.n_active_tasks %}
                      <div><i class="fas fa-thumbtack"></i> <strong>{{ work.task_stats.n_active_tasks }}</strong> Active tasks</div>
                      <div class="progress mt-1 progress-thin">
                        <div class="progress-bar task-badge-open" style="width: {{ work.task_stats.open_task_ratio }}%" title="open"></div>
                        <div class="progress-bar task-badge-pending_review" style="width: {{ work.task_stats.pending_task_ratio }}%" title="pending review"></div>
                      </div>
                    {% endif %}
                  </div>

                  <div class="col-2">
                    {% if work.filtered_docs %}
                      <div>
                        <span title="Points in time"><i class="far fa-clock"></i> <strong>{{ work.filtered_docs|length }}</strong></span>
                        {% if work.n_annotations %}
                          <i class="ml-2 far fa-comments"></i> {{ work.n_annotations }}
                        {% endif %}
                      </div>
                      <div class="progress mt-1 progress-thin">
                        <div class="progress-bar bg-primary" style="width: {{ work.pub_ratio }}%" title="published"></div>
                        <div class="progress-bar bg-warning" style="width: {{ work.drafts_ratio }}%" title="drafts"></div>
                      </div>
                    {% endif %}
                  </div>

                  <div class="col-2">
                    <span class="time-ago" data-timestamp="{{ work.most_recent_updated_at|date:'c' }}">{{ work.most_recent_updated_at|date:"Y-m-d H:i" }}</span>
                    {% if work.most_recent_updated_by %}
                      {% if work.most_recent_updated_by == request.user %}
                        you
                      {% else %}
                        <div class="text-muted">by {% user_profile work.most_recent_updated_by %}</div>
                      {% endif %}
                    {% endif %}
                  </div>
                </div>

                {% if work.filtered_docs %}
                  <div class="collapse work-extra-detail mt-1" id="work-detail-{{ work.pk }}">
                    {% for doc in work.filtered_docs %}
                      <div class="d-flex">
                        <div class="col-2">
                          <a href="{% url 'document' doc_id=doc.pk %}">@ {{ doc.expression_date|date:"Y-m-d" }} Â· {{ doc.language.code }}</a>
                        </div>

                        <div class="col-4">
                          {% if doc.draft %}
                            <i class="fas fa-fw fa-circle draft" title="draft"></i>
                          {% else %}
                            <i class="fas fa-fw fa-circle published" title="published"></i>
                          {% endif %}
                          {{ doc.title }}
                        </div>

                        <div class="col-2">
                          {% if doc.task_stats.n_active_tasks %}
                            <div>
                              <i class="fas fa-thumbtack"></i> <strong>{{ doc.task_stats.n_active_tasks }}</strong> Active tasks
                            </div>
                            <div class="progress mt-1 progress-thin">
                              <div class="progress-bar task-badge-open" style="width: {{ doc.task_stats.open_task_ratio }}%" title="open"></div>
                              <div class="progress-bar task-badge-pending_review" style="width: {{ doc.task_stats.pending_task_ratio }}%" title="pending review"></div>
                            </div>
                          {% endif %}
                        </div>

                        <div class="col-2">
                          {% if doc.n_annotations %}
                            <i class="far fa-comments"></i> {{ doc.n_annotations }}
                          {% endif %}
                        </div>

                        <div class="col-2">
                          <span class="time-ago" data-timestamp="{{ doc.updated_at|date:'c' }}">{{ doc.updated_at|date:'Y-m-d H:i' }}</span>
                          {% if doc.updated_by_user == request.user %}
                            you
                          {% else %}
                            <div class="text-muted">by {% user_profile doc.updated_by_user %}</div>
                          {% endif %}
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  {% if is_paginated %}
    <nav class="mt-4">
      {% include 'indigo_app/_paginator.html' with params=form.data_as_url %}
    </nav>
  {% endif %}

</div>

{% endblock %}

{% block js %}
  {{ block.super }}

  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
      // check if any advanced filter check is selected on load and expand the
      // advanced section on page load
      let primaryWorkFilter = document.getElementById('primary_work_filter').value;

      if ($("#work-filter-form input:checkbox:checked").length > 0) {
        $('.collapse').collapse('show');

      } else if ( primaryWorkFilter === 'only' || primaryWorkFilter === 'excl' ) {
        $('.collapse').collapse('show');
      }
    });

    function checkAssentDate(){
      // if assent_date checkbox is clicked, make the dates required fields
      if (document.getElementById('assent_date_check').checked) {
        document.getElementById("assent_date_start").required = true;
        document.getElementById("assent_date_end").required = true;
      } else {
        document.getElementById("assent_date_start").required = false;
        document.getElementById("assent_date_end").required = false;      
      }
    }

    function checkPublicationDate(){
      // if publication _date checkbox is clicked, make the dates required fields
      if (document.getElementById('publication_date_check').checked) {
        document.getElementById("publication_date_start").required = true;
        document.getElementById("publication_date_end").required = true;
      } else {
        document.getElementById("publication_date_start").required = false;
        document.getElementById("publication_date_end").required = false;      
      }
    }

    function checkRepealDate(){
      // if repealed date checkbox is clicked, make the dates required fields
      if (document.getElementById('repealed_date_check').checked) {
        document.getElementById("repealed_date_start").required = true;
        document.getElementById("repealed_date_end").required = true;
      } else {
        document.getElementById("repealed_date_start").required = false;
        document.getElementById("repealed_date_end").required = false;      
      }
    }

    function checkCommencementDate(){
      // if commencement date checkbox is clicked, make the dates required fields
      if (document.getElementById('commencement_date_check').checked) {
        document.getElementById("commencement_date_start").required = true;
        document.getElementById("commencement_date_end").required = true;
      } else {
        document.getElementById("commencement_date_start").required = false;
        document.getElementById("commencement_date_end").required = false;      
      }
    }

    function checkAmendDate(){
      // if amendment date checkbox is clicked, make the dates required fields
      if (document.getElementById('amendment_date_check').checked) {
        document.getElementById("amendment_date_start").required = true;
        document.getElementById("amendment_date_end").required = true;
      } else {
        document.getElementById("amendment_date_start").required = false;
        document.getElementById("amendment_date_end").required = false;      
      }
    }

  // if any advanced filter is applied, keep the section expanded   
  </script>
  <script src="{% static 'lib/chart.js-2.8.0/Chart.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'lib/chart.js-2.8.0/Chart.min.css' %}">
{% endblock %}
