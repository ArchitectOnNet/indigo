{% extends "place/tabbed_layout.html" %}
{% load indigo_app humanize staticfiles %}

{% block title %}{{ place.name }}{% endblock %}

{% block content %}
<div class="container mt-3 mb-5">

  <div class="row">
    <div class="col">
      <div class="card mt-3">
        <h5 class="card-header"> Open Tasks </h5>
        <div class="card-body">
          {% for item in open_tasks %}
            {% if item.count %}
              <div class="row">
                <div class="col-4">
                  <i class="fas fa-sm fa-fw task-icon-{{ item.state }}" title="{{ itemstate }}"></i>
                  {{ item.state_string }}
                </div>
                <div class="col-6">
                  <div class="progress" style="border-radius: 3px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ item.percentage }}%"></div>
                  </div>
                </div>
                <div class="col-2">
                  <span class="text-muted">{{ item.count }} task{{ item.count|pluralize }}</span>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
        <div class="card-footer">
          <a href="{% url 'tasks' place=place.place_code %}" class="card-link">Tasks →</a>
        </div>
      </div>

      <div class="card mt-3">
        <h5 class="card-header">Types of Works</h5>
        <div class="card-body">
          <div class="card-body">
            <div class="p-relative">
              <canvas id="works_by_type-chart" data-values="{{ subtypes }}"></canvas>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <a href="{% url 'place_metrics' place=place.place_code %}" class="card-link">Metrics →</a>
        </div>
      </div>

      <div class="card mt-3">
        <h5 class="card-header">Stubs and Subsidiary Legislation</h5>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-2"> Stubs </div>
            <div class="col-7">
              <div class="progress" style="border-radius: 3px; height: 20px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ stubs_percentage }}%" aria-valuenow="{{ stubs_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                <div class="progress-bar" role="progressbar" style="width: {{ non_stubs_percentage }}%" aria-valuenow="{{ non_stubs_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div> 
            </div>
            <div class="col-3"> Non-stubs </div>
          </div>

          <div class="row">
            <div class="col-2"> Primary </div>
            <div class="col-7">
              <div class="progress" style="border-radius: 3px; height: 20px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ primary_works_percentage }}%" aria-valuenow="{{ primary_works_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                <div class="progress-bar" role="progressbar" style="width: {{ subsidiary_works_percentage }}%" aria-valuenow="{{ subsidiary_works_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div> 
            </div>
            <div class="col-3"> Subsidiary </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card mt-3">
        <h5 class="card-header">As at</h5>
        <div class="card-body">
          <h5 class="card-text">{% now "Y-m-d" %}</h5>
        </div>
      </div>

      <div class="card mt-3">
        <h5 class="card-header">Recent Activity</h5>
        <div class="card-body">
          <div class="p-relative" style="height: 100px">
            <canvas id="activity-chart" data-values="{{ activity_history }}"></canvas>
          </div>
        </div>
        <div class="card-footer">
          <a href="{% url 'place_metrics' place=place.place_code %}" class="card-link">Metrics →</a>
        </div>        
      </div>

      <div class="card mt-3">
        <h5 class="card-header">Most Incomplete Works</h5>        
        <div class="card-body">
          <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
          <a href="#" class="card-link">Card link</a>
          <a href="#" class="card-link">Another link</a>
        </div>
      </div>

      <div class="card mt-3">
        <h5 class="card-header">Top Contributors</h5>        
        <div class="card-body">
          <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
          <a href="#" class="card-link">Card link</a>
          <a href="#" class="card-link">Another link</a>
        </div>
      </div>      

    </div>
  </div>

  <div class="card mt-3">
    <h5 class="card-header">Recently updated works</h5>
    <div class="card-body">
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Work</th>
            <th>Updates</th>
          </tr>
        </thead>
        {% for work in recently_updated_works %}
          <tr>
            <td>
              <a href="{% url 'work' frbr_uri=work.frbr_uri %}" data-popup-url="{% url 'work_popup' frbr_uri=work.frbr_uri %}">{{ work.title }}</a>
              {% if work.repealed_date %} <span class="badge badge-info">repealed</span> {% endif %}
              <span class="text-muted">· {{ work.frbr_uri }}</span>
            </td>
            <td>
              <span class="time-ago" data-timestamp="{{ work.updated_at|date:'c' }}">{{ work.updated_at|date:"Y-m-d H:i" }}</span>
                {% if work.updated_by_user %}
                  by
                  {% if work.updated_by_user == request.user %}
                    you
                  {% else %}
                    <div class="text-muted">by {% user_profile work.updated_by_user %}</div>
                  {% endif %}
                {% endif %}
            </td>
          </tr>
        {% endfor %}
      </table>
    </div>
    <div class="card-footer">
      <a href="{% url 'place_works' place=place.place_code %}">All works →</a>
    </div>
  </div>

  <div class="card mt-3">
    <h5 class="card-header">Recently added works</h5>
    <div class="card-body">
      <table class="table table-sm">
        <thead>
        <tr>
          <th>Work</th>
          <th>Added</th>
        </tr>
        </thead>
        {% for work in recently_created_works %}
          <tr>
            <td>
              <a href="{% url 'work' frbr_uri=work.frbr_uri %}" data-popup-url="{% url 'work_popup' frbr_uri=work.frbr_uri %}">{{ work.title }}</a>
              {% if work.repealed_date %} <span class="badge badge-info">repealed</span> {% endif %}
              <span class="text-muted">· {{ work.frbr_uri }}</span>
            </td>
            <td>
              <span class="time-ago" data-timestamp="{{ work.created_at|date:'c' }}">{{ work.created_at|date:"Y-m-d H:i" }}</span>
              {% if work.created_by_user %}
                by
                {% if work.created_by_user == request.user %}
                  you
                {% else %}
                  <div class="text-muted">by {% user_profile work.created_by_user %}</div>
                {% endif %}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </table>
    </div>
    <div class="card-footer">
      <a href="{% url 'place_works' place=place.place_code %}">All works →</a>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
  {{ block.super }}

  <script src="{% static 'lib/chart.js-2.8.0/Chart.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'lib/chart.js-2.8.0/Chart.min.css' %}">
{% endblock %}
